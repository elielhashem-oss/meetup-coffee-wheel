/**
 * Script for logging spin attempts and submissions (wins) 
 * with enforcement for spin frequency and weekly wins.
 */

const SHEET_NAME = 'Sheet1'; // VERIFIED: Must be 'Sheet1'
const MAX_SPINS_PER_HOUR = 2; // Maximum spins allowed in 60 minutes
const WIN_LIMIT_DAYS = 7;    // User can only submit/win once every 7 days

// Helper function for creating consistent JSON responses
function createJsonResponse(data) {
    return ContentService.createTextOutput(JSON.stringify(data))
                         .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
    let result = {};
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    // CRITICAL FIX: Correctly referencing the SHEET_NAME variable
    const sheet = ss.getSheetByName(SHEET_NAME); 
    
    if (!e || !e.postData || !e.postData.contents) {
        return createJsonResponse({ status: 'error', message: 'No data provided' });
    }
    
    try {
        let data = JSON.parse(e.postData.contents);
        const userPhone = data.phone;
        
        // --- 1. CORE VALIDATION CHECKS ---
        const lastActivity = getLastActivity(sheet, userPhone);

        const isOfficialWin = data.prize && data.prize !== "Try Again";

        let entryType = "ATTEMPT";
        let denialReason = "";
        
        if (isSpinLimited(lastActivity)) {
            denialReason = "RATE LIMITED - SPIN DENIED";
            entryType = "DENIED_SPIN";
        } else if (isOfficialWin && isWinLimited(lastActivity)) {
            denialReason = "RATE LIMITED - WIN DENIED";
            entryType = "DENIED_WIN";
        } else if (isOfficialWin) {
            entryType = "WIN"; // Confirmed, legitimate win
        }
        
        // --- 2. DATA LOGGING ---
        let prizeStatus = denialReason || data.prize;
        let finalCode = denialReason ? "N/A" : data.code;
        
        // Prepare row data based on Sheet Structure (A-F, Index 0-5)
        let rowData = [
            new Date(),      // Index 0: Timestamp
            data.name,       // Index 1: Name
            data.phone,      // Index 2: Phone
            prizeStatus,     // Index 3: Prize (or Denial Reason)
            finalCode,       // Index 4: Prize Code
            entryType        // Index 5: Entry Type (WIN, ATTEMPT, DENIED_WIN, DENIED_SPIN)
        ];
        
        sheet.appendRow(rowData);
        
        if (denialReason) {
             result.status = 'limited';
             result.message = 'Rate limit applied: ' + denialReason;
        } else {
             result.status = 'success';
             result.message = 'Data recorded successfully';
        }
        
    } catch (error) {
        Logger.log("POST CRASH ERROR: " + error.toString()); 
        result.status = 'error';
        result.message = 'Internal server error. Please check script logs.';
        
    } finally {
        return createJsonResponse(result);
    }
}

/**
 * Retrieves the last spin and last win time for the user, and hourly spin count.
 */
function getLastActivity(sheet, phone) {
    const data = sheet.getDataRange().getValues();
    data.shift(); // Remove headers

    const PHONE_COL = 2; // Column C
    const TIMESTAMP_COL = 0; // Column A
    const PRIZE_COL = 3; // Column D (Used to count all spins/attempts)
    const TYPE_COL = 5; // Column F (Used to confirm official 'WIN' entries)

    let lastSpinTime = 0;
    let lastWinTime = 0;
    let spinCountHour = 0;
    const oneHourMs = 60 * 60 * 1000;
    const now = new Date().getTime();

    for (let i = data.length - 1; i >= 0; i--) {
        const row = data[i];

        if (row[PHONE_COL] === phone) {
            const entryTime = new Date(row[TIMESTAMP_COL]).getTime();
            
            // 1. Check for confirmed WIN (must have 'WIN' in Column F)
            if (row[TYPE_COL] === "WIN" && lastWinTime === 0) {
                lastWinTime = entryTime;
            }

            // 2. Check for spin count within the last hour (based on ALL entries)
            if (row[PRIZE_COL] && (now - entryTime < oneHourMs)) {
                spinCountHour++;
            }

            // 3. Check for last Spin time
            if (lastSpinTime === 0) {
                lastSpinTime = entryTime;
            }
        }
    }

    if (lastSpinTime === 0) {
        lastSpinTime = now - oneHourMs; 
    }
    
    return { lastSpinTime, lastWinTime, spinCountHour };
}

/**
 * Enforces the 2 spins per hour limit.
 */
function isSpinLimited(activity) {
    return activity.spinCountHour >= MAX_SPINS_PER_HOUR;
}

/**
 * Enforces the 1 win per week limit.
 */
function isWinLimited(activity) {
    if (activity.lastWinTime === 0) {
        return false;
    }
    const winLimitMs = WIN_LIMIT_DAYS * 24 * 60 * 60 * 1000;
    const now = new Date().getTime();
    
    return (now - activity.lastWinTime) < winLimitMs;
}





